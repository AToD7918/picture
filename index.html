<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Photos</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;overflow:hidden;touch-action:pan-y}
  .viewer{width:100vw;height:100vh;display:flex;align-items:center;justify-content:center}
  img{max-width:100%;max-height:100%;object-fit:contain;user-select:none}
</style>
</head>
<body>

<div class="viewer">
  <img id="big" alt="">
</div>

<script>
(async () => {
  // 강제 새로고침: 페이지 로드 시 항상 캐시 무시
  if (performance.navigation.type !== 1) {
    location.reload(true);
    return;
  }

  const ts = Date.now();
  const manifest = await fetch('manifest.json?_=' + ts).then(r=>r.json());
  const images = manifest.images || [];
  const params = new URLSearchParams(location.search);
  let idx = Math.max(0, images.findIndex(x => x.id === params.get('id')));
  if (idx === -1) idx = 0;

  const big = document.getElementById('big');

  function render(i){
    if (!images[i]) return;
    big.src = images[i].src + '?_=' + ts;
    big.alt = images[i].alt || '';
    history.replaceState(null,'', images[i].id ? `?id=${encodeURIComponent(images[i].id)}` : location.pathname);
  }

  // 터치 스와이프
  let touchStartX = 0;
  let touchEndX = 0;
  
  document.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
  }, {passive: true});
  
  document.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    const diff = touchStartX - touchEndX;
    
    if (Math.abs(diff) > 50) {
      if (diff > 0) {
        idx = (idx + 1) % images.length;
      } else {
        idx = (idx - 1 + images.length) % images.length;
      }
      render(idx);
    }
  }, {passive: true});

  // 키보드 화살표
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      idx = (idx - 1 + images.length) % images.length;
      render(idx);
    } else if (e.key === 'ArrowRight') {
      idx = (idx + 1) % images.length;
      render(idx);
    }
  });

  render(idx);
})();
</script>
</body>
</html>